{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Chat about: {{ product.title }}</h5>
                    <a href="{{ url_for('main.product_detail', product_id=product.id) }}" class="btn btn-outline-primary btn-sm">View Product</a>
                </div>
                <div class="card-body">
                    <div id="chat-messages" class="mb-3" style="height: 400px; overflow-y: auto;">
                        {% for message in messages %}
                            <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %} mb-2">
                                <div class="message-content p-2 rounded {% if message.sender_id == current_user.id %}bg-primary text-white{% else %}bg-light{% endif %}" style="max-width: 70%;">
                                    <small class="d-block text-muted">{{ message.sender.username }} - {{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {{ message.message }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <form id="chat-form" class="mt-3">
                        <div class="input-group">
                            <input type="text" id="message-input" class="form-control" placeholder="Type your message..." required>
                            <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message {
    display: flex;
    margin-bottom: 1rem;
}
.message.sent {
    justify-content: flex-end;
}
.message-content {
    word-wrap: break-word;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    
    // Scroll to bottom of chat
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Handle form submission
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        try {
            const response = await fetch(`/chat/send/{{ product.id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `message=${encodeURIComponent(message)}`
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Add message to chat
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent mb-2';
                messageDiv.innerHTML = `
                    <div class="message-content p-2 rounded bg-primary text-white" style="max-width: 70%;">
                        <small class="d-block text-muted">${data.sender} - ${data.timestamp}</small>
                        ${data.message}
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                
                // Clear input and scroll to bottom
                messageInput.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                alert(data.error || 'Failed to send message');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to send message');
        }
    });
    
    // Poll for new messages
    setInterval(async function() {
        try {
            const response = await fetch(`/chat/messages?product_id={{ product.id }}`);
            const messages = await response.json();
            
            // Update chat with new messages
            messages.forEach(msg => {
                if (!document.querySelector(`[data-message-id="${msg.id}"]`)) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender === '{{ current_user.username }}' ? 'sent' : 'received'} mb-2`;
                    messageDiv.setAttribute('data-message-id', msg.id);
                    messageDiv.innerHTML = `
                        <div class="message-content p-2 rounded ${msg.sender === '{{ current_user.username }}' ? 'bg-primary text-white' : 'bg-light'}" style="max-width: 70%;">
                            <small class="d-block text-muted">${msg.sender} - ${msg.timestamp}</small>
                            ${msg.message}
                        </div>
                    `;
                    chatMessages.appendChild(messageDiv);
                }
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
            console.error('Error polling messages:', error);
        }
    }, 3000);
});
</script>
{% endblock %}
